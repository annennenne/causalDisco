---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# causalDisco <img src="man/figures/hex.png" width="80" height="80" align="right" alt="" />

<!-- badges: start -->
[![Codecov test coverage](https://codecov.io/gh/BjarkeHautop/causalDisco/graph/badge.svg)](https://app.codecov.io/gh/BjarkeHautop/causalDisco)
[![R-CMD-check](https://github.com/BjarkeHautop/causalDisco/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BjarkeHautop/causalDisco/actions/workflows/R-CMD-check.yaml)
[![CRAN status](https://www.r-pkg.org/badges/version/causalDisco)](https://CRAN.R-project.org/package=causalDisco)
<!-- badges: end -->

`causalDisco` provides a unified interface for causal discovery on observational data.
It wraps multiple causal discovery backends under a common, consistent syntax. 

## Motivation

Causal discovery methods exist in many ecosystems, for example in `bnlearn`, `pcalg`, or `Tetrad`, but their APIs vary widely.

`causalDisco` unifies them under one clear grammar, making it easy to compare results, switch algorithms, and focus on scientific questions rather than package quirks.

Time to hit the disco ðŸª©

## Installation 

### Install `causalDisco`

To install `causalDisco` ensure you first have installed Rust and Java/JDK as described below.

Then you can install the development version of `causalDisco` from GitHub using `pak`:

```{r, eval=FALSE}
pak::pkg_install("https://github.com/BjarkeHautop/causalDisco")
```

### Installing Rust

`causalDisco` depends on the package [`caugi`](https://github.com/frederikfabriciusbjerre/caugi), which requires Rust to
be installed on your system. See https://www.rust-lang.org/tools/install for instructions on how to
install Rust.

### Installing Java / JDK

`causalDisco` provides an interface to the Java library [`Tetrad`](https://github.com/cmu-phil/tetrad) for
causal discovery algorithms. To use algorithms from `Tetrad` you need to install a Java Development Kit (JDK).
We recommend Eclipse Temurin (OpenJDK), available at https://adoptium.net 

You may also refer to `Tetrad`'s
[Java setup guide](https://github.com/cmu-phil/tetrad/wiki/Setting-up-Java-for-Tetrad).

The current supported version of `Tetrad` can then be installed by calling

```{r, eval=FALSE}
causalDisco::install_tetrad()
```

## Example

With `causalDisco` you can currently run causal discovery algorithms from the packages `causalDisco` itself,
the Java library `Tetrad`, `bnlearn`, and `pcalg`.

```{r example}
library(causalDisco)

# load data
data("tpcExample")

# define background knowledge object
kn <- knowledge(
  tpcExample,
  tier(
    child ~ starts_with("child"),
    youth ~ starts_with("youth"),
    old ~ starts_with("old")
  )
)

# use Tetrad PC algorithm with conditional Gaussian test
# Requires Tetrad to be installed
if (check_tetrad_install()$installed) {
  tetrad_pc <- pc(engine = "tetrad", test = "conditional_gaussian", alpha = 0.05)
  disco_tetrad_pc <- disco(data = tpcExample, method = tetrad_pc, knowledge = kn)

  # similarly, one could do
  tetrad_pc <- tetrad_pc |> set_knowledge(kn)
  disco_tetrad_pc_new <- tetrad_pc(tpcExample)
}

# use causalDisco's own tges algorithm with temporal BIC score
cd_tges <- tges(engine = "causalDisco", score = "tbic")
disco_cd_tges <- disco(data = tpcExample, method = cd_tges, knowledge = kn)
```

You can visualize the resulting causal graph using the `plot()` function:

```{r plot}
#| fig.alt: "A causal graph with the known tiers indicated by vertical positioning of the nodes."
plot(disco_cd_tges)
```

## Questions

- We say in `?bnlearnSearch` (and implemented in `bnlearn_search`) various algorithms such as `gs`, `iamb`. However,
we don't have a `gs(), iamb()` function exported (similar to how we have a `pc()` function). Should we add these functions? 

Is it a work in progress? If so we need to document this in `?bnlearnSearch` (and similar for other functions)?.

## TODO

### Manging exported functions

- Do we need to export the run functions (`tpc_run`, ...) if we recommend user to use `disco()` with the method functions (`tpc`, ...)?

- Various helper functions: `as_pcalg_constraints`, ..., `is_knowledgeable_caugi`, ..., `tetrad_graph`

### Dependencies

- Currently you can't install `causalDisco` without having Java/JDK installed. Move all `rJava` stuff to optional and
start up only initialize `rJava` if installed?

### Bugfixes

#### causalDisco issues

- `tpc` with engine `causalDisco` does not currently work correctly with tier knowledge

```{r}
data("tpcExample")

kn <- knowledge(
  tpcExample,
  tier(
    child ~ starts_with("child"),
    youth ~ starts_with("youth"),
    old ~ starts_with("old")
  )
)

my_tpc <- tpc(engine = "causalDisco", test = "fisher_z")

output <- disco(tpcExample, my_tpc, knowledge = kn)
edges <- output$caugi@edges

violations <- causalDisco:::check_tier_violations(edges, kn)
violations
```

- All of our algorithms (I think?) does not work with required edges from knowledge objects (see e.g. [unit tests for tfci](https://github.com/BjarkeHautop/causalDisco/tree/master/tests/testthat/test-tfci.R)), `tpc`, `tges`, ...
Currently does nothing. Either make it work or throw error/warning if required edges are given.

  - Look into how (if) possible to pass to `pcalg`.

- Piping as done above for `Tetrad` in the example section loses `$knowledge$tiers` information due to how
  builders/closures capture knowledge.

  - Fixing requires refactoring the disco_method builder design I think.

#### Tetrad issues

`Tetrad` v7.6.9 might fix some of these issues?

- `Tetrad` does not use tier knowledge correctly yet. If giving tier knowledge it still returns undirected edges between
tiers (see [unit tests for pc](https://github.com/BjarkeHautop/causalDisco/tree/master/tests/testthat/test-pc.R#L1)). 
Could it be because the graph looks like this:

```{r, eval = FALSE}
violations <- causalDisco:::check_tier_violations(edges, kn)
> violations
# A tibble: 2 Ã— 5
  from      edge  to       tier_from tier_to
  <chr>     <chr> <chr>        <int>   <int>
1 oldage_x5 ---   youth_x3         3       2
2 oldage_x6 ---   youth_x4         3       2
```

And it only tries to fix it from the other way? I.e. if to and from were swapped? More investigation needed ...

It also breaks on required edges if paired with tier knowledge.

- Running `Tetrad` engine many times gives java.lang.RuntimeException. Try e.g. to run the code below.

```{r, eval = FALSE}
data("tpcExample")
# This erros on my machine with error
# Error in .jcall("RJavaTools", "Ljava/lang/Object;", "invokeMethod", cl,  : 
#  java.lang.RuntimeException


# Some memory leakage it seems like - is it our fault?
# Confirmed it also happens on v7.6.7 and v.7.6.9 

tetrad_pc <- pc(engine = "tetrad", test = "conditional_gaussian", alpha = 0.05)
kn <- knowledge(
  tpcExample,
  required(child_x1 ~ youth_x3)
)
for (i in 1:1000) {
  output <- disco(data = tpcExample, method = tetrad_pc, knowledge = kn)
}
```

### Documentation 

- Make templates.

- Structure the documentation better. See See how `mlr3` does it, and see their wiki on roxygen R6 guide [here](https://github.com/mlr-org/mlr3/wiki/Roxygen-R6-Guide).

  - Make it clear somewhere what/how knowledge is supported in which algorithms. E.g. `pc` with engine `pcalg` only works
with forbidden edges from knowledge objects and requires specifying both ways. It's documented in `?as_pcalg_constaints` but should be more visible.

Maybe make it possible to check documentation of engine via `?pcalg` and similar for the rest?

  - List in documentation of `tfci`, ... what kind of graph it returns. `tfci` gives a PAG, right? Currently it returns `graph_class: UNKNOWN`
    - Either wait/help for `caugi` to implement different classes
    - Or we implement a function that converts `caugi` output to specific graph classes based on algorithm/edges?
    - Update plotting function to work correctly with different graph classes.

- Make vignettes

### Standardization

- We are mixing between different things currently (since we rely on `caugi` are it uses `data.frame` and `S7`):
  - `tibble` vs `data.frame` (e.g. `knowledge` is `tibble` and `disco()$caugi@edges` is `data.frame`)
  - `S3` vs `S7`
  - More maybe?

### Adopt Tetrad v7.6.9

- Move to `Tetrad` v7.6.9. v7.6.9 removes the folder [algcomparison/algorithm/cluster](https://github.com/cmu-phil/tetrad/tree/v7.6.8/tetrad-lib/src/main/java/edu/cmu/tetrad/algcomparison/algorithm/cluster)

Was removed in this commit https://github.com/cmu-phil/tetrad/commit/295dceef6b83ac08ff0032fb194cf3ee5e429337#diff-adf829223cc59eac11682310f8a77c0ec3cf26a5b4310d75ec8edfaa86dd285b

[Changelog](https://github.com/cmu-phil/tetrad/releases) item 14 says 
"and a generalization of GFFC (Generalized Find Factor Clusters) of FOFC and FTFC, providing multiple strategies for discovering latent clusterings from measurement data."

so we need to implement this in `causalDisco` (help?)

### CRAN TODO

- Add a copyright holder (`"cph"`) in persons field of DESCRIPTION (needed for CRAN, see [here](https://github.com/DavisVaughan/extrachecks))

- Update Description: field in DESCRIPTION to mention it wraps other packages, ...

## Bugs & requests

Bug reports and feature requests are welcome:

ðŸ‘‰ [open an issue](https://github.com/BjarkeHautop/causalDisco/issues).
